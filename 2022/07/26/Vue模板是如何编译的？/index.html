<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Vue模板是如何编译的？"><meta name="keywords" content="Vue"><meta name="author" content="qinwei"><meta name="copyright" content="qinwei"><title>Vue模板是如何编译的？ | QW's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.2'
} </script><meta name="generator" content="Hexo 5.4.2"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%86%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91"><span class="toc-text">认识模板编译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E8%AF%A6%E8%A7%A3-%E6%BA%90%E7%A0%81"><span class="toc-text">模板编译详解 - 源码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#baseCompile"><span class="toc-text">baseCompile()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-parse"><span class="toc-text">1.parse()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-optimize"><span class="toc-text">2.optimize()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-generate"><span class="toc-text">3.generate()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-genElement"><span class="toc-text">4.genElement()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#render-%E5%87%BD%E6%95%B0"><span class="toc-text">render 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84render"><span class="toc-text">自定义的render</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%B8%B2%E6%9F%93%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-text">1.渲染优先级</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%9B%B4%E7%81%B5%E6%B4%BB%E7%9A%84%E5%86%99%E6%B3%95"><span class="toc-text">2.更灵活的写法</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-text">小结</span></a></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/qw-null/BlogImages/20211013182113.JPG"></div><div class="author-info__name text-center">qinwei</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/qw-null">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">156</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">45</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">29</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/qw-null/BlogImages/223.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">QW's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/categories">分类</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/archives">创作时间线</a><a class="site-page" target="_blank" rel="noopener" href="https://github.com/qw-null">Github</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">Vue模板是如何编译的？</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-07-26</time><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">3.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 13 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h3 id="认识模板编译"><a href="#认识模板编译" class="headerlink" title="认识模板编译"></a>认识模板编译</h3><p>在Vue文件中使用<code>&lt;template&gt;&lt;/template&gt; </code>表示模板，其内部包裹的代码并不是原生的HTML，因此浏览器是不认识模板的。所以我们要做的工作就是把<code>&lt;template&gt;&lt;/template&gt;</code>内部的代码编译成浏览器认识的原生HTML，这就是模板编译。</p>
<p>页面从<code>&lt;template&gt;&lt;/template&gt;</code>包裹的代码到视图最终展示的主要流程是</p>
<ol>
<li>提取出模板中的原生HTML和非原生HTML（比如绑定的属性、事件、指令等）</li>
<li>经过一些处理生成render函数</li>
<li>render函数再将模板内容生成对应的VNode</li>
<li>再经过patch过程（Diff）得到要渲染到视图的VNode</li>
<li>最后根据VNode创建真实DOM节点，也就是原生的HTML插入到视图中，完成渲染</li>
</ol>
<p>上述的1，2，3步骤就是模板编译的过程。<br>那代码究竟在步骤2中发生了什么？它是怎么编译，最终生成render函数的呢？</p>
<h3 id="模板编译详解-源码"><a href="#模板编译详解-源码" class="headerlink" title="模板编译详解 - 源码"></a>模板编译详解 - 源码</h3><h4 id="baseCompile"><a href="#baseCompile" class="headerlink" title="baseCompile()"></a>baseCompile()</h4><p>这个就是模板编译的入口函数，接收两个参数：1.<code>template</code>:就是要转换的模板字符串；2.<code>options</code>:就是转换时需要的参数</p>
<p>编译的流程主要有三步：</p>
<ol>
<li>模板解析：通过正则等方式提取出<code>&lt;template&gt;&lt;/template&gt;</code>里的标签元素、属性、变量等信息，并解析成抽象语法树AST</li>
<li>优化：遍历AST找出其中的静态节点和静态根节点，并进行标记</li>
<li>代码生成：根据AST生成渲染函数render</li>
</ol>
<p>上述三个步骤分别对应三个函数。</p>
<p>首先查看<code>baseCompile()</code>函数在哪里调用，即<strong>模板编译从那里开始</strong>。<br>源码地址：<code>src/complier/index.js - 11行</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createCompiler = <span class="title function_">createCompilerCreator</span>(<span class="keyword">function</span> <span class="title function_">baseCompile</span> (</span><br><span class="line">  <span class="attr">template</span>: string, <span class="comment">// 就是要转换的模板字符串</span></span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">CompilerOptions</span> <span class="comment">//就是转换时需要的参数</span></span><br><span class="line">): <span class="title class_">CompiledResult</span> &#123;</span><br><span class="line">  <span class="comment">// 1. 进行模板解析，并将结果保存为 AST</span></span><br><span class="line">  <span class="keyword">const</span> ast = <span class="title function_">parse</span>(template.<span class="title function_">trim</span>(), options)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 没有禁用静态优化的话</span></span><br><span class="line">  <span class="keyword">if</span> (options.<span class="property">optimize</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="comment">// 2. 就遍历 AST，并找出静态节点并标记</span></span><br><span class="line">    <span class="title function_">optimize</span>(ast, options)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 3. 生成渲染函数</span></span><br><span class="line">  <span class="keyword">const</span> code = <span class="title function_">generate</span>(ast, options)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ast,</span><br><span class="line">    <span class="attr">render</span>: code.<span class="property">render</span>, <span class="comment">// 返回渲染函数 render</span></span><br><span class="line">    <span class="attr">staticRenderFns</span>: code.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<p>上述的3个步骤在源码中均体现出来，接下来看一下具体的编译流程是啥样的。<br>以以下模板为例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span>&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>打印编译后的结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  ast<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    type<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    tag<span class="punctuation">:</span> &#x27;div&#x27;<span class="punctuation">,</span></span><br><span class="line">    attrsList<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span> name<span class="punctuation">:</span> &#x27;id&#x27;<span class="punctuation">,</span> value<span class="punctuation">:</span> &#x27;app&#x27; <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    attrsMap<span class="punctuation">:</span> <span class="punctuation">&#123;</span> id<span class="punctuation">:</span> &#x27;app&#x27; <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    rawAttrsMap<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    parent<span class="punctuation">:</span> undefined<span class="punctuation">,</span></span><br><span class="line">    children<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        type<span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        expression<span class="punctuation">:</span> &#x27;_s(name)&#x27;<span class="punctuation">,</span></span><br><span class="line">        tokens<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span> &#x27;@binding&#x27;<span class="punctuation">:</span> &#x27;name&#x27; <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        text<span class="punctuation">:</span> &#x27;<span class="punctuation">&#123;</span><span class="punctuation">&#123;</span>name<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">        static<span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    plain<span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    attrs<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span> name<span class="punctuation">:</span> &#x27;id&#x27;<span class="punctuation">,</span> value<span class="punctuation">:</span> &#x27;<span class="string">&quot;app&quot;</span>&#x27;<span class="punctuation">,</span> dynamic<span class="punctuation">:</span> undefined <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    static<span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    staticRoot<span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  render<span class="punctuation">:</span> `with(this)<span class="punctuation">&#123;</span>return _c(&#x27;div&#x27;<span class="punctuation">,</span><span class="punctuation">&#123;</span>attrs<span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;app&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">[</span>_v(_s(name))<span class="punctuation">]</span>)<span class="punctuation">&#125;</span>`<span class="punctuation">,</span></span><br><span class="line">  staticRenderFns<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  errors<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  tips<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>生成的内容看起来有些吃力，实际上注意以下三个步骤都做了什么就行了：</p>
<ul>
<li>ast字段是第一步生成的</li>
<li>static字段，就是标记，是在第二步中根据ast里的type加上去的</li>
<li>render字段，就是第三步生成的</li>
</ul>
<hr>
<p>再来看源码。</p>
<h4 id="1-parse"><a href="#1-parse" class="headerlink" title="1.parse()"></a>1.parse()</h4><p><img src="https://cdn.jsdelivr.net/gh/qw-null/BlogImages/20220726105550.png"></p>
<p>实现的功能是 通过正则等方法提取出来<code>&lt;template&gt;&lt;/template&gt;</code>模板字符串里所有的tag、props、children信息，生成一个对应结构的ast对象 。</p>
<p>parse()接收两个参数：</p>
<ul>
<li>template：就是要转换的模板字符串</li>
<li>options：就是转换时需要的参数。它包含有四个钩子函数，就是用来把parseHTML解析出来的字符串提取出来，并生成对应的AST</li>
</ul>
<p>核心步骤如下：<br>调用<code>parseHTML</code>函数对模板字符串进行解析：</p>
<ul>
<li>解析到开始标签、结束标签、文本、注释分别进行不同的处理</li>
<li>解析过程中遇到文本信息就调用文本解析器<code>parseText</code>函数进行文本解析</li>
<li>解析过程中遇到包含过滤器，就调用过滤器解析器<code>parseFilters</code>函数进行解析</li>
</ul>
<p>每一步解析的结果都合并到一个对象上（就是最后的AST）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parse()的部分源码</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parse</span> (</span><br><span class="line">  <span class="attr">template</span>: string, <span class="comment">// 要转换的模板字符串</span></span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">CompilerOptions</span> <span class="comment">// 转换时需要的参数</span></span><br><span class="line">): <span class="title class_">ASTElement</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="title function_">parseHTML</span>(template, &#123;</span><br><span class="line">    warn,</span><br><span class="line">    <span class="attr">expectHTML</span>: options.<span class="property">expectHTML</span>,</span><br><span class="line">    <span class="attr">isUnaryTag</span>: options.<span class="property">isUnaryTag</span>,</span><br><span class="line">    <span class="attr">canBeLeftOpenTag</span>: options.<span class="property">canBeLeftOpenTag</span>,</span><br><span class="line">    <span class="attr">shouldDecodeNewlines</span>: options.<span class="property">shouldDecodeNewlines</span>,</span><br><span class="line">    <span class="attr">shouldDecodeNewlinesForHref</span>: options.<span class="property">shouldDecodeNewlinesForHref</span>,</span><br><span class="line">    <span class="attr">shouldKeepComment</span>: options.<span class="property">comments</span>,</span><br><span class="line">    <span class="attr">outputSourceRange</span>: options.<span class="property">outputSourceRange</span>,</span><br><span class="line">    <span class="comment">// 解析到开始标签时调用，如 &lt;div&gt;</span></span><br><span class="line">    start (tag, attrs, unary, start, end) &#123;</span><br><span class="line">        <span class="comment">// unary 是否是自闭合标签，如 &lt;img /&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 解析到结束标签时调用，如 &lt;/div&gt;</span></span><br><span class="line">    end (tag, start, end) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 解析到文本时调用</span></span><br><span class="line">    chars (<span class="attr">text</span>: string, <span class="attr">start</span>: number, <span class="attr">end</span>: number) &#123;</span><br><span class="line">      <span class="comment">// 这里会判断判断很多东西，来看它是不是带变量的动态文本</span></span><br><span class="line">      <span class="comment">// 然后创建动态文本或静态文本对应的 AST 节点</span></span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 解析到注释时调用</span></span><br><span class="line">    comment (<span class="attr">text</span>: string, start, end) &#123;</span><br><span class="line">      <span class="comment">// 注释是这么找的</span></span><br><span class="line">      <span class="keyword">const</span> comment = <span class="regexp">/^&lt;!\--/</span></span><br><span class="line">      <span class="keyword">if</span> (comment.<span class="title function_">test</span>(html)) &#123;</span><br><span class="line">      <span class="comment">// 如果是注释，就继续找 &#x27;--&gt;&#x27;</span></span><br><span class="line">      <span class="keyword">const</span> commentEnd = html.<span class="title function_">indexOf</span>(<span class="string">&#x27;--&gt;&#x27;</span>)</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 返回的这个就是 AST</span></span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面解析文本时调用<code>chars()</code>会根据不同类型的节点加上不同type，来标记AST节点类型，这个属性在下一步标记的时候也会用的</p>
<table>
<thead>
<tr>
<th>type</th>
<th>AST 节点类型</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>元素节点</td>
</tr>
<tr>
<td>2</td>
<td>包含变量的动态文本节点</td>
</tr>
<tr>
<td>3</td>
<td>没有变量的纯文本节点</td>
</tr>
</tbody></table>
<h4 id="2-optimize"><a href="#2-optimize" class="headerlink" title="2.optimize()"></a>2.optimize()</h4><p>这个函数就是在AST里找出静态节点和静态根节点，并添加标记，为了后面patch过程中，直接跳过静态节点的比对，直接克隆一份过去，从而优化patch的性能。</p>
<p>optimize()的大致过程：</p>
<ul>
<li><p>标记静态节点（markStatic），就是判断type是上面哪种类型（type值的1，2，3）</p>
</li>
<li><ul>
<li>type的值为1：就是包含子元素的节点，设置static为false，并递归标记子节点，直到标记完所有的子节点</li>
</ul>
</li>
<li><ul>
<li>type的值为2：设置static为false</li>
</ul>
</li>
<li><ul>
<li>type的值为3: 就是不包含子节点和动态属性的纯文本节点，把它的static = true，patch的时候就会跳过这个，直接克隆一份</li>
</ul>
</li>
<li><p>标记静态根节点（markStaticRoots），这里的原理和标记静态节点基本相同，知识需要满足下面条件的节点才算是静态根节点</p>
</li>
<li><ul>
<li>节点本身必须是静态节点</li>
</ul>
</li>
<li><ul>
<li>必须有子节点</li>
</ul>
</li>
<li><ul>
<li>子节点不能只有一个文本节点</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">optimize</span> (<span class="attr">root</span>: ?<span class="title class_">ASTElement</span>, <span class="attr">options</span>: <span class="title class_">CompilerOptions</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!root) <span class="keyword">return</span></span><br><span class="line">  isStaticKey = <span class="title function_">genStaticKeysCached</span>(options.<span class="property">staticKeys</span> || <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  isPlatformReservedTag = options.<span class="property">isReservedTag</span> || no</span><br><span class="line">  <span class="comment">// 标记静态节点</span></span><br><span class="line">  <span class="title function_">markStatic</span>(root)</span><br><span class="line">  <span class="comment">// 标记静态根节点</span></span><br><span class="line">  <span class="title function_">markStaticRoots</span>(root, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-generate"><a href="#3-generate" class="headerlink" title="3.generate()"></a>3.generate()</h4><p>这个就是生成render的函数，就是说最终会返回下面这个东东</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 比如有这么个模板</span></span><br><span class="line">&lt;template&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span>&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上面模板编译后返回的 render 字段 就是这样的</span></span><br><span class="line"><span class="attr">render</span>: <span class="string">`with(this)&#123;return _c(&#x27;div&#x27;,&#123;attrs:&#123;&quot;id&quot;:&quot;app&quot;&#125;&#125;,[_v(_s(name))])&#125;`</span></span><br></pre></td></tr></table></figure>
<p>可以看出上面的render正是虚拟DOM的结构，就是把一个标签分为tag、props、children。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 把内容格式化一下，容易理解一点</span></span><br><span class="line"><span class="title function_">with</span>(<span class="params"><span class="variable language_">this</span></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">_c</span>(</span><br><span class="line">    <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">    &#123; <span class="attr">attrs</span>:&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;app&quot;</span>&#125; &#125;,</span><br><span class="line">    [  <span class="title function_">_v</span>(<span class="title function_">_s</span>(name))  ]</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>其中<code>with</code>是用来欺骗词法作用域的，它可以让我们更快的饮用一个对象上的多个属性<br><img src="https://cdn.jsdelivr.net/gh/qw-null/BlogImages/20220726130648.png"></p>
<p>函数内部的<code>_c</code>、<code>_v</code>、<code>_s</code>分别表示什么含义？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 其实不止这几个，由于本文例子中没有用到就没都复制过来占位了</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">installRenderHelpers</span> (<span class="attr">target</span>: any) &#123;</span><br><span class="line">  target.<span class="property">_s</span> = toString <span class="comment">// 转字符串函数</span></span><br><span class="line">  target.<span class="property">_l</span> = renderList <span class="comment">// 生成列表函数</span></span><br><span class="line">  target.<span class="property">_v</span> = createTextVNode <span class="comment">// 创建文本节点函数</span></span><br><span class="line">  target.<span class="property">_e</span> = createEmptyVNode <span class="comment">// 创建空节点函数</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 补充</span></span><br><span class="line">_c = createElement <span class="comment">// 创建虚拟节点函数</span></span><br></pre></td></tr></table></figure>
<hr>
<p>继续看generator()的源码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">generate</span> (</span><br><span class="line">  <span class="attr">ast</span>: <span class="title class_">ASTElement</span> | <span class="keyword">void</span>,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">CompilerOptions</span></span><br><span class="line">): <span class="title class_">CodegenResult</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> state = <span class="keyword">new</span> <span class="title class_">CodegenState</span>(options)</span><br><span class="line">  <span class="comment">// 就是先判断 AST 是不是为空，不为空就根据 AST 创建 vnode，否则就创建一个空div的 vnode</span></span><br><span class="line">  <span class="keyword">const</span> code = ast ? (ast.<span class="property">tag</span> === <span class="string">&#x27;script&#x27;</span> ? <span class="string">&#x27;null&#x27;</span> : <span class="title function_">genElement</span>(ast, state)) : <span class="string">&#x27;_c(&quot;div&quot;)&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">render</span>: <span class="string">`with(this)&#123;return <span class="subst">$&#123;code&#125;</span>&#125;`</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: state.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个流程很简单，就是判断AST是不是为空，不为空就根据AST创建VNode，否则就创建一个空的div的VNode。<br>创建VNode主要是通过<code>genElement()</code>函数来实现的。</p>
<h4 id="4-genElement"><a href="#4-genElement" class="headerlink" title="4.genElement()"></a>4.genElement()</h4><p>这个函数的逻辑很清晰，通过<code>if/else</code>判断传进来的AST元素节点的属性，来执行不同的生成函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">genElement</span> (<span class="attr">el</span>: <span class="title class_">ASTElement</span>, <span class="attr">state</span>: <span class="title class_">CodegenState</span>): string &#123;</span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">parent</span>) &#123;</span><br><span class="line">    el.<span class="property">pre</span> = el.<span class="property">pre</span> || el.<span class="property">parent</span>.<span class="property">pre</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">staticRoot</span> &amp;&amp; !el.<span class="property">staticProcessed</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genStatic</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">once</span> &amp;&amp; !el.<span class="property">onceProcessed</span>) &#123; <span class="comment">// v-once</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genOnce</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">for</span> &amp;&amp; !el.<span class="property">forProcessed</span>) &#123; <span class="comment">// v-for</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genFor</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">if</span> &amp;&amp; !el.<span class="property">ifProcessed</span>) &#123; <span class="comment">// v-if</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genIf</span>(el, state)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// template 节点 &amp;&amp; 没有插槽 &amp;&amp; 没有 pre 标签</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">tag</span> === <span class="string">&#x27;template&#x27;</span> &amp;&amp; !el.<span class="property">slotTarget</span> &amp;&amp; !state.<span class="property">pre</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genChildren</span>(el, state) || <span class="string">&#x27;void 0&#x27;</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">tag</span> === <span class="string">&#x27;slot&#x27;</span>) &#123; <span class="comment">// v-slot</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genSlot</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// component or element</span></span><br><span class="line">    <span class="keyword">let</span> code</span><br><span class="line">    <span class="comment">// 如果有子组件</span></span><br><span class="line">    <span class="keyword">if</span> (el.<span class="property">component</span>) &#123;</span><br><span class="line">      code = <span class="title function_">genComponent</span>(el.<span class="property">component</span>, el, state)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> data</span><br><span class="line">      <span class="comment">// 获取元素属性 props</span></span><br><span class="line">      <span class="keyword">if</span> (!el.<span class="property">plain</span> || (el.<span class="property">pre</span> &amp;&amp; state.<span class="title function_">maybeComponent</span>(el))) &#123;</span><br><span class="line">        data = <span class="title function_">genData</span>(el, state)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 获取元素子节点</span></span><br><span class="line">      <span class="keyword">const</span> children = el.<span class="property">inlineTemplate</span> ? <span class="literal">null</span> : <span class="title function_">genChildren</span>(el, state, <span class="literal">true</span>)</span><br><span class="line">      code = <span class="string">`_c(&#x27;<span class="subst">$&#123;el.tag&#125;</span>&#x27;<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">        data ? <span class="string">`,<span class="subst">$&#123;data&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span> // data</span></span></span><br><span class="line"><span class="subst"><span class="string">      &#125;</span><span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">        children ? <span class="string">`,<span class="subst">$&#123;children&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span> // children</span></span></span><br><span class="line"><span class="subst"><span class="string">      &#125;</span>)`</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// module transforms</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; state.<span class="property">transforms</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      code = state.<span class="property">transforms</span>[i](el, code)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回上面作为 with 作用域执行的内容</span></span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在这里还可以发现v-for的优先级高于v-if</p>
</blockquote>
<h3 id="render-函数"><a href="#render-函数" class="headerlink" title="render 函数"></a>render 函数</h3><p>在Vue项目的<code>main.js</code>文件中，存在以下代码：<img src="https://cdn.jsdelivr.net/gh/qw-null/BlogImages/20220725164129.png"><br>调用render函数会得到传入的模板（<code>.vue</code>文件）对应的虚拟DOM，那么这个render函数是从哪里来的？它是如何将<code>.vue</code>文件转换成浏览器可识别的代码的呢？</p>
<p>render函数的来源有两种方式：</p>
<ul>
<li>第一种就是经过模板编译生成render函数</li>
<li>第二种是我们自己定义在组件里的render函数，这种会跳过模板编译的过程</li>
</ul>
<h4 id="自定义的render"><a href="#自定义的render" class="headerlink" title="自定义的render"></a>自定义的render</h4><p><img src="https://cdn.jsdelivr.net/gh/qw-null/BlogImages/20220726131746.png"><br>上面三种情况最后编译出的内容完全一样。<br>那么，你一定会有一个疑问，既然模板能自己编译自动生成，为什么还要提出自定义render？<br>原因有二：</p>
<ol>
<li>自己把VNode写了，就会直接跳过模板编译，不用再经历模板编译过程中解析模板动态属性、事件、指令等，所以性能上会有所提升。这一点在下面的渲染优先级上有所体现。</li>
<li>还有一些情况，能让我们的代码写法更加灵活，更加方便简洁，不会冗余</li>
</ol>
<p><em>（在Element-UI的组件源码中就有大量的重写render函数）</em></p>
<h5 id="1-渲染优先级"><a href="#1-渲染优先级" class="headerlink" title="1.渲染优先级"></a>1.渲染优先级</h5><p>Vue的生命周期中关于模板编译的部分，如下<br><img src="https://cdn.jsdelivr.net/gh/qw-null/BlogImages/20220726142359.png"><br>从图中可以知道，如果有<code>template</code>，就不会管<code>el</code>，所以<strong>template比el的优先级更高</strong>。</p>
<p>那我们自己手写的render函数呢？</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&#x27;app&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; name &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">el</span>:<span class="string">&#x27;#app&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">data</span>:&#123; <span class="attr">name</span>:<span class="string">&#x27;沐华&#x27;</span> &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">template</span>:<span class="string">&#x27;&lt;div&gt;掘金&lt;/div&gt;&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">render</span>(<span class="params">h</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, <span class="string">&#x27;好好学习，天天向上&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>结果在页面上渲染出来的只有<code>&lt;div&gt;好好学习，天天向上&lt;/div&gt;</code>。因此，<strong>render函数的优先级更高</strong>。<br>所以，综上所述：<span style="background-color:yellow; font-weight:800;">优先级：render函数 &gt; template &gt; outerHTML </span><br>因为不管是<code>el</code>挂载的<code>outerHTML</code>，还是<code>template</code>，最后都会被编译成<code>render</code>函数，而如果已经有了<code>render</code>函数，就跳过前面的编译。这一点在源码中也有体现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"> el, hydrating </span>) &#123;</span><br><span class="line">   el = el &amp;&amp; <span class="title function_">query</span>(el);</span><br><span class="line">   <span class="keyword">var</span> options = <span class="variable language_">this</span>.<span class="property">$options</span>;</span><br><span class="line">   <span class="comment">// 如果没有 render </span></span><br><span class="line">   <span class="keyword">if</span> (!options.<span class="property">render</span>) &#123;</span><br><span class="line">     <span class="keyword">var</span> template = options.<span class="property">template</span>;</span><br><span class="line">     <span class="comment">// 再判断，如果有 template</span></span><br><span class="line">     <span class="keyword">if</span> (template) &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">typeof</span> template === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (template.<span class="title function_">charAt</span>(<span class="number">0</span>) === <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line">           template = <span class="title function_">idToTemplate</span>(template);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (template.<span class="property">nodeType</span>) &#123;</span><br><span class="line">         template = template.<span class="property">innerHTML</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">       &#125;</span><br><span class="line">     <span class="comment">// 再判断，如果有 el</span></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el) &#123;</span><br><span class="line">       template = <span class="title function_">getOuterHTML</span>(el);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> mount.<span class="title function_">call</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>

<h5 id="2-更灵活的写法"><a href="#2-更灵活的写法" class="headerlink" title="2.更灵活的写法"></a>2.更灵活的写法</h5><p>以如下代码为例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-if</span>=<span class="string">&quot;level === 1&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;xxx&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">v-else-if</span>=<span class="string">&quot;level === 2&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;xxx&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">h3</span> <span class="attr">v-else-if</span>=<span class="string">&quot;level === 3&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;xxx&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="attr">props</span>:[<span class="string">&#x27;level&#x27;</span>]</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>我们可以换一种方式，写出和上面编译效果一样的代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">props</span>:[<span class="string">&#x27;level&#x27;</span>],</span><br><span class="line">    <span class="title function_">render</span>(<span class="params">h</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;h&#x27;</span> + <span class="variable language_">this</span>.<span class="property">level</span>, <span class="variable language_">this</span>.<span class="property">$slots</span>.<span class="title function_">default</span>())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>或者下面这样，多次调用的时候就很方便</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">props</span>:[<span class="string">&#x27;level&#x27;</span>],</span><br><span class="line">    <span class="title function_">render</span>(<span class="params">h</span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> tag = <span class="string">&#x27;h&#x27;</span> + <span class="variable language_">this</span>.<span class="property">level</span></span><br><span class="line">      <span class="keyword">return</span> (<span class="language-xml"><span class="tag">&lt;<span class="name">tag</span>&gt;</span>&#123;this.$slots.default()&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><img src="https://cdn.jsdelivr.net/gh/qw-null/BlogImages/20220726154204.png" alt="何为模板编译？"></p>
<p><img src="https://cdn.jsdelivr.net/gh/qw-null/BlogImages/20220913150808.png" alt="模板编译详解"></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">qinwei</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://qw-null.github.io/2022/07/26/Vue模板是如何编译的？/">https://qw-null.github.io/2022/07/26/Vue模板是如何编译的？/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://qw-null.github.io">QW's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Vue/">Vue</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/07/27/11-%E6%88%91%E7%9C%BC%E4%B8%AD%E7%9A%84-%E6%B7%B1%E6%8B%B7%E8%B4%9D%E5%92%8C%E6%B5%85%E6%8B%B7%E8%B4%9D/"><i class="fa fa-chevron-left">  </i><span>【我眼中的】 - 【11】深拷贝和浅拷贝</span></a></div><div class="next-post pull-right"><a href="/2022/07/25/VUE%E7%9A%84diff%E7%AE%97%E6%B3%95/"><span>说一说Vue的diff算法</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '44447f6848cb1055dfc7',
  clientSecret: '62722601a7b62e7a2f93add8216a30d9f047a2eb',
  repo: 'CommentData',
  owner: 'qw-null',
  admin: 'qw-null',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/qw-null/BlogImages/223.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2024 By qinwei</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>